<!DOCTYPE html>
<html lang="en_US">

<head>
    <link href="css/common.css" rel="stylesheet" type="text/css">
    <link href="css/sprite.css" rel="stylesheet" type="text/css">
    <link href="css/multi2.css" rel="stylesheet" type="text/css">
    <link href="css/loading.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <style>
        .tier__icon {
            vertical-align: baseline !important;
        }

        .multi2__item .summoner-summary .last-updated {
            text-align: center;
        }

        body {
            padding: 10px;
        }

        #name-input {
            width: 430px;
        }
    </style>
</head>

<body>
    <textarea id="name-input"></textarea>
    <button id="submit-name">Submit</button>
    <form style="display:inline">
        <label for="area-id">Area ID:</label>
        <select id="areas">
            <option>1 艾欧尼亚</option>
            <option>2 比尔吉沃特</option>
            <option>3 祖安</option>
            <option>4 诺克萨斯</option>
            <option>5 班德尔城</option>
            <option>6 德玛西亚</option>
            <option>7 皮尔特沃夫</option>
            <option>8 战争学院</option>
            <option>9 弗雷尔卓德</option>
            <option>10 巨神峰</option>
            <option>11 雷瑟守备</option>
            <option>12 无畏先锋</option>
            <option>13 裁决之地</option>
            <option>14 黑色玫瑰</option>
            <option>15 暗影岛</option>
            <option>16 恕瑞玛</option>
            <option>17 钢铁烈阳</option>
            <option>18 水晶之痕</option>
            <option>19 均衡教派</option>
            <option>20 扭曲丛林</option>
            <option>22 影流</option>
            <option>23 守望之海</option>
            <option>24 征服之海</option>
            <option>25 卡拉曼达</option>
            <option>26 巨龙之巢</option>
            <option>27 皮城警备</option>
            <option>30 男爵领域</option>
            <option>31 峡谷之巅</option>
        </select>
    </form>
    <div class="loader" id="loader" style="display:none;">Loading...</div>
    <div class="ContentWrap">
        <div class="multi2">
            <div class="multi2__box">
                <ul class="multi2__list">
                </ul>
            </div>
        </div>
    </div>
    <template class="player_template">
        <li class="multi2__item">
            <div class="summoner-summary">
                <div class="last-updated">
                    Last played: <span class="_timeago _timeCountAssigned tip" data-datetime="" data-type=""
                        data-interval="60" title="">0 days ago</span>
                </div>
                <div class="tier-position">
                    <div class="tier">
                        <img class="tier__icon" src="">
                    </div>
                    <!--
                    <div class="most-position">
                        <i class="most-position__icon most-position__icon--MID"></i>
                    </div>
                    -->
                </div>
                <div class="summoner-name">
                    <a class="name" href="#" target="_blank">
                    </a>
                </div>
                <div class="lp"></div>
                <div class="graph">
                    <span class="winratio">50%</span>
                </div>
                <div class="win-streak win-streak--wins">
                </div>
            </div>
            <div class="recent-matches">
                <!--
                <div class="title">Recently Played</div>
                <div class="positions">
                    <div class="position">
                        <i class="position__icon position__icon--MID"></i>
                        <div class="position__info">
                            <div class="role-rate role-rate--high">50%</div>
                            <div class="win-rate">W/R <strong>50%</strong></div>
                        </div>
                    </div>
                    <div class="position">
                        <i class="position__icon position__icon--TOP"></i>
                        <div class="position__info">
                            <div class="role-rate ">50%</div>
                            <div class="win-rate">W/R <strong>50%</strong></div>
                        </div>
                    </div>
                </div>
                -->
                <ul class="recent-games">
                </ul>
            </div>
        </li>
    </template>
    <template class="recent_game_template">
        <li class="recent-games__item">
            <div class="champion __sprite __spc20 __spc20-2 tip" title=""></div>
            <img class="champion __sprite __spc20 __spc20-123 tip tpd-delegation-uid-1">
            <div class="is-win is-win--true ">
                <span class="kill"></span> /
                <span class="death"></span> /
                <span class="assist"></span>
            </div>
            <div class="time-stamp"><span class="_timeago _timeCountAssigned tip tpd-delegation-uid-1" data-datetime=""
                    data-type="" data-interval="60" title="" data-toggle="tooltip"></span>
            </div>
        </li>
    </template>
</body>
<script>

    let index = 0

    const _champ = "../res/champions/"
    const _rank = "../res/division/"

    function timeConverter(UNIX_timestamp) {
        const a = new Date(UNIX_timestamp * 1000);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const year = a.getFullYear();
        const month = months[a.getMonth()];
        const date = a.getDate();
        const hour = a.getHours();
        const min = a.getMinutes();
        const sec = a.getSeconds();
        const time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;
        return time;
    }

    function create_multi_profile(jdata) {
        document.getElementById("loader").style.display = "none"
        //begin create users
        const temp = document.getElementsByTagName("template")[0];
        const view = document.getElementsByClassName("multi2__list")[0];
        const startElement = temp.content.querySelector("li");

        var posArray = [0, 0, 0, 0, 0]
        const a = document.importNode(startElement, true);

        //shorthand
        const player = jdata
        const battle_list = jdata.player_battle_brief_list
        f = function (arguments) { return a.getElementsByClassName(arguments)[0]; }

        for (z = 0; z < Object.keys(battle_list).length; z++) {
            posArray[battle_list[z].position] += 1
        }

        //populate user data from JSON
        f("summoner-name").innerHTML = "<a class='name' href='#'>" + player.role_name + "</a>"
        f("tier__icon").src = _rank + player.tier + "_" + player.rank + ".png"
        f("lp").innerText = player.league_point + "LP"
        f("winratio").innerText = player.win_rate + "%"

        if (player.continue_lose > 0) {
            f("win-streak").innerText = player.continue_lose + " game lose streak"
            f("win-streak").style.backgroundColor = "red";
        } else if (player.continue_win > 0) {
            f("win-streak").innerText = player.continue_win + " game win streak"
        } else {
            f("win-streak").innerText = ""
        }

        view.appendChild(a);

        //battle_list[0] for most recent game.
        if (battle_list[0].battle_time) {
            const deltaT = Date.now() / 1000 - battle_list[0].battle_time
            const lastPlayed = (secondsToDhms(deltaT))
            f("_timeago").innerText = lastPlayed
        } else {
            f("_timeago").innerText = "No recent games on record"
        }

        //begin create user match history
        for (z = 0; z < Object.keys(battle_list).length; z++) {
            const recentview = view.getElementsByClassName("recent-games")[index]
            const recentList = document.getElementsByTagName("template")[1].content.querySelector("li");
            const b = document.importNode(recentList, true);
            const b_list = battle_list[z]

            f = function (arguments) { return b.getElementsByClassName(arguments)[0]; }

            f("champion __sprite __spc20 __spc20-123 tip tpd-delegation-uid-1").src = _champ + b_list.champion_id + ".png"
            if (b_list.game_result === 2) {
                f("is-win is-win--true").setAttribute("class", "is-win is-win--false")
            }
            f("kill").innerText = b_list.kill_num
            f("death").innerText = b_list.death_num
            f("assist").innerText = b_list.assist_num
            f("_timeago").setAttribute("data-datetime", b_list.battle_time);
            f("_timeago").innerText = timeConverter(b_list.battle_time);
            f("_timeago").title = timeConverter(b_list.battle_time);
            $('[data-toggle="tooltip"]').tooltip();
            recentview.appendChild(b);
        }
        index += 1
    }

    function secondsToDhms(seconds) {
        seconds = Number(seconds);
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor(seconds % (3600 * 24) / 3600);
        const m = Math.floor(seconds % 3600 / 60);
        const s = Math.floor(seconds % 60);

        const dDisplay = d > 0 ? d + (d == 1 ? " day, " : " days, ") : "";
        const hDisplay = h > 0 ? h + (h == 1 ? " hour, " : " hours ") : "";
        const mDisplay = m > 0 ? m + (m == 1 ? " minute, " : " minutes, ") : "";
        const sDisplay = s > 0 ? s + (s == 1 ? " second" : " seconds") : "";
        return dDisplay + hDisplay + " ago"
    }

    document.getElementById("submit-name").addEventListener('click', function () {
        let names = document.getElementById("name-input").value
        let usernames = names.replaceAll("加入了队伍聊天", "").split(/\r?\n/)
        console.log(usernames)
        for (k in usernames) {
            if (usernames[k] != "") {
                let request = {
                    "type": "profile-multi",
                    "name": usernames[k],
                    "area_id": area_id
                }
                sendMessage(JSON.stringify(request))
            }
        }
    })

    if (localStorage.getItem("area_id")) {
        area_id = parseInt(localStorage.getItem("area_id"))
        for (let i = 0; i < document.getElementById("areas").getElementsByTagName("option").length; i += 1) {
            if (parseInt(document.getElementById("areas").getElementsByTagName("option")[i].value.split(" ")[0]) === area_id) {
                document.getElementById("areas").getElementsByTagName("option")[i].setAttribute("selected", "selected")
            }
        }
    }

    document.getElementById("areas").addEventListener("change", function () {
        area_id = parseInt(document.getElementById("areas").value.split(" ")[0])
        localStorage.setItem("area_id", area_id)
    })

    function receiveMessage(message) {
        console.log(message.data)
        if (message.origin != "//downthecrop.github.io") {
            try {
                JSON.parse(message.data)
            } catch (e) {
                console.log("Message isn't jData")
                console.log(message.data)
                if (message.data === "loading") {
                    document.getElementById("loader").style.display = "inline"
                    document.getElementsByClassName("multi2__list")[0].innerHTML = ""
                }
                if (message.data === "ticket-error") {
                    document.body.innerHTML = "<h1>Ticket Error</h1>"
                }
            }
            let jMessage = JSON.parse(message.data)
            if (jMessage.type === "profile-multi-reply") {
                create_multi_profile(jMessage)
            }
        }
    }

    function sendMessage(message) {
        parent.postMessage(message, '*');
    }
    window.addEventListener('message', receiveMessage);
</script>

</html>